name: Juez Implacable (Auditor√≠a Multiverso)

on:
  push:
    paths:
      - 'data/*_MAESTRO.csv' # Se activa solo si subes resultados nuevos (Loto, Racha, etc.)
  workflow_dispatch: # Bot√≥n manual
  schedule:
    - cron: '0 */6 * * *' # Ejecutar cada 6 horas para limpieza autom√°tica

permissions:
  contents: write

jobs:
  judge:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repo
      uses: actions/checkout@v3

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: Install dependencies
      run: |
        pip install pandas numpy tabulate

    # 0. El consolidador (Aqu√≠ se borran los archivos JSON del DISCO tras unirse al CSV)
    - name: 0. Consolidar Cola de Predicciones
      run: python engine/tools/consolidar_cola.py

    # 1. AUDITOR√çA: Revisa si ganamos algo con los datos nuevos
    - name: Ejecutar Juez Multiverso
      run: python engine/models/juez_implacable.py

    # 2. APRENDIZAJE: Actualiza el Genoma y la Biometr√≠a al instante
    - name: Ejecutar Entrenador Cognitivo
      run: python engine/models/entrenador_cognitivo.py

    - name: Actualizar Biometr√≠a
      run: python engine/models/generador_biometrico.py

    # --- NUEVO PASO: GENERACI√ìN DEL REPORTE MD ---
    - name: Generar Reporte Comparativo (v3 vs v4)
      run: python engine/tools/comparar_modelos.py

    # 3. GUARDADO BLINDADO (Commit Local + Rebase Loop)
    - name: Publicar Veredictos e Inteligencia
      run: |
        git config --global user.name 'Juez LotoAI'
        git config --global user.email 'juez@lotoai.com'
        
        # --- FASE 1: COMMIT LOCAL ---
        # 'git add .' incluir√° autom√°ticamente el nuevo COMPARATIVA_MODELOS.md
        git add .
        
        if git diff-index --quiet HEAD; then
          echo "‚öñÔ∏è Todo en orden, no hubo cambios de auditor√≠a ni limpieza pendiente."
          exit 0
        else
          git commit -m "‚öñÔ∏è Ciclo de Verdad: Auditor√≠a y Reporte Comparativo actualizados"
        fi

        # --- FASE 2: SINCRONIZACI√ìN ROBUSTA (El Bucle de la Perseverancia) ---
        MAX_RETRIES=10
        COUNT=0
        SUCCESS=0
        
        while [ $COUNT -lt $MAX_RETRIES ]; do
          echo "üîÑ Sincronizando Juez con el Multiverso (Intento $COUNT/$MAX_RETRIES)..."
          
          if git pull origin main --rebase; then
            if git push origin main; then
              echo "‚úÖ Veredicto dictado y guardado."
              SUCCESS=1
              break
            else
              echo "‚ö†Ô∏è Push rechazado. Reintentando..."
            fi
          else
            echo "‚ö†Ô∏è Conflicto en Rebase. Reintentando..."
            git rebase --abort
            git stash || true 
          fi
          
          sleep $((RANDOM % 10 + 5))
          COUNT=$((COUNT+1))
        done
        
        if [ $SUCCESS -eq 0 ]; then
          echo "‚ùå Error: El Juez no pudo dictar sentencia tras varios intentos."
          exit 1
        fi